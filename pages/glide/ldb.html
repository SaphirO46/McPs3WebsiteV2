<!doctype html>
<html class="no-js" lang="">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/app.css">

	<meta name="description" content="">

	<meta property="og:title" content="">
	<meta property="og:type" content="">
	<meta property="og:url" content="">
	<meta property="og:image" content="">
	<meta property="og:image:alt" content="">

	<link rel="icon" href="/favicon.ico" sizes="any">
	<link rel="icon" href="/icon.svg" type="image/svg+xml">
	<link rel="apple-touch-icon" href="/icon.png">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
	<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
	<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">

	<link rel="manifest" href="/site.webmanifest">
	<meta name="theme-color" content="#fafafa">
</head>

<body>
	<style>
		.tab-ldb-glide {
			max-width: 90%;
			margin: auto;
			font-size: 0.70rem;
		}

		.input-ldb-player {
			max-width: 60%;
			margin: auto;
			display: flex;
			justify-content: center;
		}

		.division-info-fixed {
			position: fixed;
			bottom: 0;
			left: 1em;
		}

		.division-info-average-cases {
			font-size: 0.8em;
		}

		.img-division-info {
			max-width: 3.3em;
		}
	</style>


	<iframe src="/header.html" style="width: 100%; height: 50px" class="header-iframe"></iframe>
	<br>
	<br>
	<input class="input is-rounded is-medium input-ldb-player" id="input-ldb-player-id" type="text"
		placeholder="Search Player" />
	<br>
	<div class="notification" id="plusButtoAdvencedFilter">
		Advenced filters <button onclick="unhideAdvencedFilters()">+</button>
	</div>
	<div id="advancedFilterGlide" class="container">
		<div class="notification is-info">
			<button class="delete" onclick="hideAdvencedFilters()"></button>
			<form id="checkboxForm">
				<label><input type="checkbox" id="headerCheckbox" value="rank"> Rank</label>
				<label><input type="checkbox" id="headerCheckbox" value="Player"> Player</label>
				<label><input type="checkbox" id="headerCheckbox" value="Cavern"> Cavern</label>
				<label><input type="checkbox" id="headerCheckbox" value="Temple"> Temple</label>
				<label><input type="checkbox" id="headerCheckbox" value="Canyon"> Canyon</label>
				<label><input type="checkbox" id="headerCheckbox" value="Kraken"> Kraken</label>
				<label><input type="checkbox" id="headerCheckbox" value="Yeti"> Yeti</label>
				<label><input type="checkbox" id="headerCheckbox" value="Dragon"> Dragon</label>
				<br>
				<label><input type="checkbox" id="headerCheckbox" value="Shrunk"> Shrunk</label>
				<label><input type="checkbox" id="headerCheckbox" value="Mobs"> Mobs</label>
				<label><input type="checkbox" id="headerCheckbox" value="Body"> Body</label>
				<label><input type="checkbox" id="headerCheckbox" value="Excalibur"> Excalibur</label>
				<label><input type="checkbox" id="headerCheckbox" value="Icarus"> Icarus</label>
				<label><input type="checkbox" id="headerCheckbox" value="Celts"> Celts</label>
				<label><input type="checkbox" id="headerCheckbox" value="average"> Average</label>
				<label><input type="checkbox" id="headerCheckbox" value="ttTime"> TT-Time</label>
				<label><input type="checkbox" id="headerCheckbox" value="Platform"> Platform</label>
				<label><input type="checkbox" id="headerCheckbox" value="Division"> Division</label>
			</form>
			<article class="message">
				<div class="message-body">
					If you remove maps with the advenced filter, the average color case and division may not be
					correct
					(Dev need to fix this)
				</div>
			</article>
		</div>
		<br>
	</div>
	</div>

	<div class="table-container">
		<table class="table is-striped is-hoverable is-fullwidth tab-ldb-glide" id="data-table">
			<thead>
				<tr>
					<th value="rank">Rank</th>
					<th value="Player">Player</th>
					<th value="Cavern">Cavern</th>
					<th value="Temple">Temple</th>
					<th value="Canyon">Canyon</th>
					<th value="Kraken">Kraken</th>
					<th value="Yeti">Yeti</th>
					<th value="Dragon">Dragon</th>
					<th value="Shrunk">Shrunk</th>
					<th value="Mobs">Mobs</th>
					<th value="Body">Body</th>
					<th value="Excalibur">Excalibur</th>
					<th value="Icarus">Icarus</th>
					<th value="Celts">Celts</th>
					<th value="average">Average</th>
					<th value="ttTime">TT-Time</th>
					<th value="Platform">Plateform</th>
					<th value="Division">Division</th>
				</tr>
			</thead>
			<tbody>
				<!-- Les lignes de données seront insérées ici -->
			</tbody>
		</table>
	</div>

	<article class="message is-small division-info-fixed not-on-mobile" id="notificationDivision">
		<div class="message-header">
			<p>Division</p>
			<button class="delete is-small" aria-label="delete" onclick="hideDivisionNotif()"></button>
		</div>
		<div class="message-body">
			<table class="table ">
				<thead>
					<tr>
						<th>
							<center><img src="/img/glide/beginner.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/intermediate.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/skilled.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/pro.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/expert.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/master.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/legend.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/elite.webp" class="img-division-info"></center>
						</th>
						<th>
							<center><img src="/img/glide/champion.webp" class="img-division-info"></center>
						</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th style="background-color: rgb(252, 149, 149); " class="division-info-average-cases">
							<center>
								Beginner<br>
								< 1:31.167 </center>
						</th>
						<th style="background-color: rgb(244, 176, 176);" class="division-info-average-cases">
							<center>intermediate<br>
								< 1:23.500 </center>
						</th>
						<th style="background-color: rgb(247, 163, 193);" class="division-info-average-cases">
							<center>Skilled<br>
								< 1:18.292 </center>
						</th>
						<th style="background-color: rgb(229, 167, 242);" class="division-info-average-cases">
							<center>Pro<br>
								< 1:14.771 </center>
						</th>
						<th style="background-color: rgb(184, 141, 249);" class="division-info-average-cases">
							<center>Expert<br>
								< 1:12.250 </center>
						</th>
						<th style="background-color: rgb(176, 164, 249);" class="division-info-average-cases">
							<center>Master<br>
								< 1:10.500 </center>
						</th>
						<th style="background-color: rgb(158, 203, 250);" class="division-info-average-cases">
							<center>Legend<br>
								< 1:08.917 </center>
						</th>
						<th style="background-color: rgb(142, 158, 247);" class="division-info-average-cases">
							<center>Elite<br>
								< 1:07.345 </center>
						</th>
						<th style="background-color: #c8f7f6;" class="division-info-average-cases">
							<center>Champion<br>
								< ALL </center>
						</th>
					</tr>
				</tbody>
			</table>
		</div>
	</article>


	<script>
		//notification hidder
		function hideDivisionNotif ()
		{
			let notif = document.getElementById("notificationDivision");
			notif.style.visibility = "hidden";
		}
		function unhideAdvencedFilters ()
		{
			let plusButton = document.getElementById("plusButtoAdvencedFilter");
			let notif = document.getElementById("advancedFilterGlide");
			plusButton.style.display = "none";
			notif.style.display = "block";
		}
		function hideAdvencedFilters ()
		{
			let notif = document.getElementById("advancedFilterGlide");
			let plusButton = document.getElementById("plusButtoAdvencedFilter");
			notif.style.display = "none";
			plusButton.style.display = "block";
		}
		//convert json 
		function csvToJson (csv)
		{
			const lines = csv.trim().split("\n");
			const headers = lines[0].split(",");

			return lines.slice(1).map(line =>
			{
				const values = line.split(",");
				return headers.reduce((obj, header, index) =>
				{
					obj[header.trim()] = values[index]?.trim();
					return obj;
				}, {});
			});
		}

		//----------------------------------------------------------------header
		//header filters

		function checkAllCheckboxesHeader ()
		{
			const headerCheckboxes = document.querySelectorAll("input[type='checkbox']#headerCheckbox");
			headerCheckboxes.forEach(checkbox =>
			{
				checkbox.checked = true; // Coche chaque case
			});
		}

		//----------------------------------------------------------------
		//modify data to json

		function addAverageTimes (data, keys)
		{
			return data.map(player =>
			{
				// Filtre les clés correspondantes aux temps et les convertit en secondes
				const times = keys.map(key => timeToSeconds(player[key]));
				const average = times.reduce((sum, time) => sum + time, 0) / times.length; // Moyenne des temps
				player.average = secondsToTime(average); // Ajoute la moyenne en format MM:SS.mmm
				return player;
			});
		}

		function addRankByJson (data)
		{
			return data.map((player, index) =>
			{
				player.rank = index + 1;
				return player;
			});
		}
		function addTtTimeByJson (data, mapKeys)
		{

			data.forEach(player =>
			{
				// Additionner les temps des cartes pour chaque joueur en secondes
				let totalTimeInSeconds = 0;
				mapKeys.forEach(map =>
				{
					totalTimeInSeconds += timeToSeconds(player[map]);
				});

				// Convertir le total en format MM:SS.mmm et ajouter au joueur
				player.ttTime = secondsToTime(totalTimeInSeconds);
			});

			return data;
		}

		function removeKeysFromJSON (jsonArray, keysToRemove)
		{
			return jsonArray.map(player =>
			{
				// Crée une copie de l'objet pour éviter de modifier l'original
				const updatedPlayer = { ...player };
				keysToRemove.forEach(key =>
				{
					delete updatedPlayer[key];
				});
				return updatedPlayer;
			});
		}

		//----------------------------------------------------------------
		//table personalisation


		function ColoredCaseByTime (key, valueCell, td, mapSelected, json)
		{
			let finalColor = [0, 0, 0];
			const glideRankyRanky = json;


			if (key == mapSelected)
			{
				const mapChoosedData = glideRankyRanky.find(mapData => mapData.Map === key);
				// Seuil spécifique pour la colonne
				const timeRankE = timeToSeconds(mapChoosedData.Times.Elite);
				const timeRankL = timeToSeconds(mapChoosedData.Times.Legend);
				const timeRankM = timeToSeconds(mapChoosedData.Times.Master);
				const timeRankX = timeToSeconds(mapChoosedData.Times.Expert);
				const timeRankP = timeToSeconds(mapChoosedData.Times.Pro);
				const timeRankS = timeToSeconds(mapChoosedData.Times.Skilled);
				const timeRankI = timeToSeconds(mapChoosedData.Times.Intermediate);
				const timeRankB = timeToSeconds(mapChoosedData.Times.Beginner);
				const cellTime = timeToSeconds(valueCell); // Convertit le temps de la cellule en secondes


				// Si le temps est supérieur au seuil, colorier la cellule en bleu
				if (cellTime > timeRankB)
				{
					finalColor = [220, 220, 220];
				}
				else if (cellTime > timeRankI)
				{
					finalColor = [252, 149, 149];
				}
				else if (cellTime > timeRankS)
				{
					finalColor = [244, 176, 176];
				}
				else if (cellTime > timeRankP)
				{
					finalColor = [247, 163, 193];
				}
				else if (cellTime > timeRankX)
				{
					finalColor = [229, 167, 242];
				}
				else if (cellTime > timeRankM)
				{
					finalColor = [184, 141, 249];
				}
				else if (cellTime > timeRankL)
				{
					finalColor = [176, 164, 249];
				}
				else if (cellTime < timeRankE)
				{
					finalColor = [142, 158, 247];
				}
				else if (cellTime >= timeRankE)
				{
					finalColor = [158, 203, 250];
				}
				else
				{
					finalColor = [0, 0, 0];
				}

				td.style.backgroundColor = "rgb(" + finalColor[0] + "," + finalColor[1] + "," + finalColor[2] + ")";




			}

		}


		//	--+++++--- Division adding to table-+++++++-----
		function AddingDivisionToTable (key, valueCell, td, mapSelected, json, rank)
		{
			let finalColor = [0, 0, 0];
			let finalDivision = "/img/glide/beginner.webp";
			const glideRankyRanky = json;
			if (key == "division" || key == "Division")
			{
				const mapChoosedData = glideRankyRanky.find(mapData => mapData.Map === "average");
				// Seuil spécifique pour la colonne
				const timeRankE = timeToSeconds(mapChoosedData.Times.Elite);
				const timeRankL = timeToSeconds(mapChoosedData.Times.Legend);
				const timeRankM = timeToSeconds(mapChoosedData.Times.Master);
				const timeRankX = timeToSeconds(mapChoosedData.Times.Expert);
				const timeRankP = timeToSeconds(mapChoosedData.Times.Pro);
				const timeRankS = timeToSeconds(mapChoosedData.Times.Skilled);
				const timeRankI = timeToSeconds(mapChoosedData.Times.Intermediate);
				const timeRankB = timeToSeconds(mapChoosedData.Times.Beginner);
				const cellTime = timeToSeconds(valueCell); // Convertit le temps de la cellule en secondes


				// Si le temps est supérieur au seuil, colorier la cellule en bleu
				if (cellTime > timeRankB)
				{
					finalDivision = "/img/glide/beginner.webp";
					finalColor = [220, 220, 220];
				}
				else if (cellTime > timeRankI)
				{
					finalDivision = "/img/glide/beginner.webp";
					finalColor = [252, 149, 149];
				}
				else if (cellTime > timeRankS)
				{
					finalDivision = "/img/glide/intermediate.webp";
					finalColor = [244, 176, 176];

				}
				else if (cellTime > timeRankP)
				{
					finalDivision = "/img/glide/skilled.webp";
					finalColor = [247, 163, 193];

				}
				else if (cellTime > timeRankX)
				{
					finalDivision = "/img/glide/pro.webp";
					finalColor = [229, 167, 242];

				}
				else if (cellTime > timeRankM)
				{
					finalDivision = "/img/glide/expert.webp";
					finalColor = [184, 141, 249];

				}
				else if (cellTime > timeRankL)
				{
					finalDivision = "/img/glide/master.webp";
					finalColor = [176, 164, 249];

				}
				else if (cellTime < timeRankE)
				{
					finalDivision = "/img/glide/elite.webp";
					finalColor = [142, 158, 247];

				}
				else if (cellTime >= timeRankE)
				{
					finalDivision = "/img/glide/legend.webp";
					finalColor = [158, 203, 250];

				}
				else
				{
					finalDivision = "/img/glide/beginner.webp";
				}
				if (rank == "1")
				{
					finalDivision = "/img/glide/champion.webp";
					finalColor = [200, 247, 246];
				}

				td.style.backgroundColor = "rgb(" + finalColor[0] + "," + finalColor[1] + "," + finalColor[2] + ")";
				td.innerHTML = '<center><img style="max-width:2.3em" src="' + finalDivision + '"></center>'
			}


		}

		function AddingPlateformLogoToTable (key, valueCell, td, mapSelected)
		{
			let finalColor = [0, 0, 0];
			let finalPlateform = "/img/glide/switch.webp";

			if (key == "Platform")
			{
				if (valueCell == "wiiuc")
				{
					finalPlateform = "/img/glide/wiiuc.webp"
				}
				else if (valueCell == "wiiu")
				{
					finalPlateform = "/img/glide/wiiu.webp"
				}
				else if (valueCell == "ps")
				{
					finalPlateform = "/img/glide/ps.webp"
				}
				else if (valueCell == "xbox")
				{
					finalPlateform = "/img/glide/xbox.webp"
				}
				else if (valueCell == "switch")
				{
					finalPlateform = "/img/glide/switch.webp"
				}
				else { finalPlateform = "/img/glide/switch.webp" }
				td.innerHTML = '<center><img style="max-width:2.3em" src="' + finalPlateform + '"></center>'
			}
		}

		//----------------------------------------------------------------
		//times configurator
		function timeToSeconds (time)
		{
			const parts = time.split(":"); // Sépare les minutes et les secondes
			const minutes = parseInt(parts[0], 10); // Convertit les minutes en no
			const seconds = parseFloat(parts[1]); // Convertit les secondes en no (décimal)
			return minutes * 60 + seconds; // Convertit tout en secondes
		}

		function sortByTime (array, key)
		{
			return array.sort((a, b) =>
			{
				const timeA = timeToSeconds(a[key]);
				const timeB = timeToSeconds(b[key]);
				return timeA - timeB; // Tri croissant
			});
		}

		function secondsToTime (seconds)
		{
			const minutes = Math.floor(seconds / 60);
			const remainingSeconds = (seconds % 60).toFixed(3); // Garde les millisecondes à 3 décimales
			return `${minutes}:${remainingSeconds.padStart(6, '0')}`; // Formate en MM:SS.mmm
		}


		//----------------------------------------------------------------
		//Preparation du Json et data table final. 
		function filterPlayersByName (players, pseudo)
		{
			return players.filter(player => player.Player.toLowerCase().includes(pseudo.toLowerCase()));
		}

		function toggleTableHeadersByValues (tableId, columnValues)
		{
			// Récupère le tableau par son ID
			const table = document.getElementById(tableId);

			if (!table)
			{
				console.error('Table not found');
				return;
			}

			// Récupère toutes les cellules <th> dans le header du tableau
			const headers = table.querySelectorAll('th');

			// Parcours chaque <th>
			headers.forEach(header =>
			{
				// Récupère la valeur de l'attribut 'value' dans le <th>
				const headerValue = header.getAttribute('value');

				// Vérifie si la valeur est dans le tableau columnValues
				if (columnValues.includes(headerValue))
				{
					// Si la valeur est dans le tableau, affiche le <th>
					header.style.display = '';
				} else
				{
					// Si la valeur n'est pas dans le tableau, cache le <th>
					header.style.display = 'none';
				}
			});
		}



		function createGlideTable (headerColumnsTable, playerSearch, keysMapsRemoved)
		{
			fetch('/csv/glideLDB.csv') // Remplacez par le chemin correct vers votre fichier CSV
				.then(response =>
				{
					if (!response.ok) throw new Error("Erreur de chargement du fichier CSV");
					return response.text();
				})
				.then(csvText =>
				{
					fetch('/csv/glideRank.json') // prend le json sa mere
						.then(response =>
						{
							if (!response.ok) throw new Error("Erreur de chargement du fichier json");
							return response.json();
						})
						.then(glideRankyRanky =>
						{
							glideRankyRanky = glideRankyRanky.gliderankyranky
							const timeKeys = ["Cavern", "Temple", "Dragon", "Body", "Canyon", "Celts", "Excalibur", "Icarus", "Kraken", "Mobs", "Shrunk", "Yeti"];
							const timeKeysToRemove = keysMapsRemoved;
							const finalTimeKeys = timeKeys.filter(key => !timeKeysToRemove.includes(key));
							const jsonData = csvToJson(csvText);
							let finalDataTable = jsonData;
							finalDataTable = removeKeysFromJSON(finalDataTable, timeKeysToRemove);
							console.log("check1");
							finalDataTable = addAverageTimes(finalDataTable, finalTimeKeys);
							console.log("check2");
							finalDataTable = addTtTimeByJson(finalDataTable, finalTimeKeys);
							console.log("check3");
							finalDataTable = sortByTime(finalDataTable, "average");
							console.log("check4");
							finalDataTable = addRankByJson(finalDataTable);
							console.log("check5");
							finalDataTable = filterPlayersByName(finalDataTable, playerSearch);
							console.log("check6");
							console.log(finalDataTable);



							//creeation du tableau
							// Insérer les données dans le tableau
							const tbody = document.querySelector("#data-table tbody");
							tbody.innerHTML = ""; // Réinitialiser le tableau

							finalDataTable.forEach(row =>
							{
								const tr = document.createElement("tr");
								for (const key of headerColumnsTable)
								{
									const td = document.createElement("td");
									td.textContent = row[key] || ""; // Si la valeur est vide, insérer une chaîne vide


									glideRankyRanky.forEach((map) =>
									{
										//adding data to table like plateform img, division, colors
										ColoredCaseByTime(key, row[key], td, map.Map, glideRankyRanky);
										AddingDivisionToTable(key, row["average"], td, map.Map, glideRankyRanky, row["rank"]);
										AddingPlateformLogoToTable(key, row["Platform"], td, map.Map);
									})

									tr.appendChild(td);
								}
								tbody.appendChild(tr);
							});

						})
						.catch(error => console.error("Erreur :", error));


				})
				.catch(error => console.error("Erreur :", error));
		}



		// Fonction pour récupérer les valeurs cochées des cases avec id="headerCheckbox"
		function getCheckedValues ()
		{
			const checkedValues = [];
			headerCheckboxes.forEach(checkbox =>
			{
				if (checkbox.checked)
				{
					checkedValues.push(checkbox.value);
				}
			});
			return checkedValues;
		}



		//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		//---------------------------------------------------------------------------------------------
		//*********************************************************************************************
		//final actions

		createGlideTable(["rank", "Player", "Cavern", "Temple", "Canyon", "Kraken", "Yeti", "Dragon", "Shrunk", "Mobs", "Body", "Excalibur", "Icarus", "Celts", "average", "ttTime", "Platform", "Division"], "", []);
		checkAllCheckboxesHeader();
		hideAdvencedFilters();

		const onlyMapKeys = ["Cavern", "Temple", "Canyon", "Kraken", "Yeti", "Dragon", "Shrunk", "Mobs", "Body", "Excalibur", "Icarus", "Celts"];
		const outputTable = document.getElementById("outputTable");
		// Sélectionne uniquement les cases avec l'id "headerCheckbox"
		const searchBar = document.getElementById("input-ldb-player-id");
		// Sélectionne uniquement les cases avec l'id "headerCheckbox"
		const headerCheckboxes = document.querySelectorAll("input[type='checkbox']#headerCheckbox");
		// Ajout d'un écouteur d'événements sur chaque checkbox correspondante
		headerCheckboxes.forEach(checkbox =>
		{
			checkbox.addEventListener("change", () =>
			{
				const updatedTable = getCheckedValues();
				let matchingKeys = updatedTable.filter(key => onlyMapKeys.includes(key));
				matchingKeys = onlyMapKeys.filter(key => !matchingKeys.includes(key));
				createGlideTable(updatedTable, searchBar.value, matchingKeys);
				toggleTableHeadersByValues('data-table', updatedTable);
			});
		});

		searchBar.addEventListener("input", () =>
		{
			const updatedTable = getCheckedValues();
			let matchingKeys = updatedTable.filter(key => onlyMapKeys.includes(key));
			matchingKeys = onlyMapKeys.filter(key => !matchingKeys.includes(key));
			createGlideTable(updatedTable, searchBar.value, matchingKeys);
			toggleTableHeadersByValues('data-table', updatedTable);
		});

	</script>

</body>